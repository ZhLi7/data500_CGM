# AIREADI — CGM Final Project

This repository contains a small sample of AIREADI study data and the supporting code used to produce the final project deliverables, including participant-level summaries and CGM time-series figures.

## Repository Layout

- **participants.Rmd** — R Markdown file that produces the final HTML report (tables + figures).
- **participants.html** — Generated HTML output (built via the Makefile).
- **data/** — Input study data:
  - participants.tsv
  - clinical_data/
  - CGM JSON files under: wearable_blood_glucose/continuous_glucose_monitoring/dexcom_g6/
- **codes/** — Supporting scripts:
  - cgm_plots.R — R script that loads Dexcom JSON and generates CGM time-series PNGs.
  - outputs/ — Generated PNG figures created by cgm_plots.R.
- **report/** — Directory for Docker-generated outputs (HTML report + figures).
- **Dockerfile** — Container definition for reproducible report generation.
- **.dockerignore** — Excludes unnecessary files from Docker build.

---

## Quick Goals and What Produces Each Output

### Final Report (tables + static figures)

Generated from participants.Rmd, including:
- Participant-level availability summary (avail_summary)
- Study-group summary table (sg_tbl)

### Required CGM Figures (example time series)

Generated by codes/cgm_plots.R, saved to: `outputs/{participant_id}.png`

---

## How to Reproduce the Entire Report

### Option 1: Local Execution (requires R + renv)

From the repository root:

```bash
make
```

or explicitly:

```bash
make report
```

**What the Makefile Does:**
- `make figures` — Runs: `Rscript codes/cgm_plots.R` → Creates all CGM PNGs in outputs/
- `make report` — Runs `make figures` first, then renders: `participants.Rmd → participants.html`
- `make clean` — Deletes generated HTML and PNGs

---

### Option 2: Docker (fully reproducible, no local R setup needed)

#### Docker Image on DockerHub

The pre-built Docker image is available at:

**[zli577/cgm-report:latest](https://hub.docker.com/r/zli577/cgm-report)**

#### Building the Docker Image Locally (Optional)

If you want to build the image yourself:

```bash
docker build -t zli577/cgm-report:latest .
```

Or use the Makefile:

```bash
make docker-build
```

#### Running the Dockerized Report Generation

The easiest way to generate the report using Docker is via the Makefile target:

**For Mac/Linux:**

```bash
make docker-run
```

**For Windows (PowerShell or Command Prompt):**

```bash
make docker-run-windows
```

**What happens:**
1. Creates an empty `report/` directory if it doesn't exist
2. Pulls the Docker image from DockerHub (if not already cached)
3. Runs the container with:
   - Your local `data/` directory mounted as read-only
   - An empty `report/` directory mounted for output
4. Inside the container, runs `make report` to:
   - Generate CGM figures
   - Render the R Markdown report
5. Copies `participants.html` and all PNG figures to your local `report/` directory
6. Container automatically removes itself after completion

**Output:**
After running, you'll find:
- `report/participants.html` — The final HTML report
- `report/*.png` — All generated CGM figures

#### Manual Docker Run (Advanced)

If you prefer to run Docker commands directly:

**Mac/Linux:**
```bash
mkdir -p report
docker run --rm \
  -v "$(pwd)/report:/project/report" \
  -v "$(pwd)/data:/project/data:ro" \
  zli577/cgm-report:latest \
  sh -c "make report && cp participants.html outputs/*.png report/"
```

**Windows (PowerShell):**
```powershell
New-Item -ItemType Directory -Force -Path report
docker run --rm `
  -v "${PWD}/report:/project/report" `
  -v "${PWD}/data:/project/data:ro" `
  zli577/cgm-report:latest `
  sh -c "make report && cp participants.html outputs/*.png report/"
```

**Windows (Command Prompt):**
```cmd
if not exist report mkdir report
docker run --rm ^
  -v "%CD%/report:/project/report" ^
  -v "%CD%/data:/project/data:ro" ^
  zli577/cgm-report:latest ^
  sh -c "make report && cp participants.html outputs/*.png report/"
```

---

## Notes and Assumptions

- Plots use participant_id as labels (no participant names available).
- Metadata (age, study_group) comes from data/participants.tsv.
- participants.Rmd uses the following R packages: tidyverse, janitor, readr, knitr, kableExtra, scales, lubridate, glue, here.
- Missing packages are installed automatically when the Rmd is rendered.
- cgm_plots.R assumes the working directory is the repository root and writes figures to outputs/.

### Note on Docker Image

The Dockerfile is complete and ready to build. Due to network connectivity issues in the development environment (persistent timeouts to Docker Hub), the image was not pre-built and pushed to DockerHub. However, the Dockerfile includes all necessary dependencies and will build successfully on systems with normal Docker Hub access using:

```bash
make docker-build
make docker-run
```

The report can also be generated locally (requires pandoc and R with renv) using:

```bash
make report
```

---

## Customization

- **To change which participants are plotted:**
  Edit codes/cgm_plots.R (defaults to first seven participants).
- **To point the report to different data:**
  Modify the file paths inside participants.Rmd.

---

## System Requirements

### Local Execution:
- R 4.5.1 or compatible
- renv (for package management)
- Required system libraries for R packages (libcurl, libxml2, etc.)

### Docker Execution:
- Docker Desktop or Docker Engine
- No R installation required
- Works on Mac, Linux, and Windows

---

## Contact / Author

**Author:** Zhongyu Li